---

- name: copy artifact
  copy:
    src={{ artifact_path }}
    dest=/artifact/{{ app_name }}
    owner=root
    group=root
    mode=0777
    
- name: run application
  shell: nohup java -jar /artifact/{{ app_name }} &
    
- name: Install git
  apt: name=git state=present
  when: SCM == 'GitSCM'
  
- name: Install svn
  apt: name=subversion state=present
  when: SCM == 'SubversionSVN'

- name: Create test directory
  file:
    path=/{{ TESTNAME }}
    state=directory
    owner=root
    group=root
    mode=0777
  when: SCM == 'GitSCM'

- name: Create directory for phantomJs
  file:
    path=/phantomjs
    state=directory
    owner=root
    group=root
    mode=0777

- name: Download phantomjs
  get_url:
    url=https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2
    dest=/phantomjs
    mode=0777

- name: untar Phantomjs
  unarchive:
    src: /phantomjs/phantomjs-2.1.1-linux-x86_64.tar.bz2
    dest: /phantomjs/
    remote_src: true

- name: Clone git test repository
  git:
    repo="{{ sit_test_repo }}"
    dest=/{{ TESTNAME }}
    clone=yes
    update=yes
    force=yes
  when: SCM == 'GitSCM'
  
- name: Clone svn test repository
  shell:
    svn co {{ sit_test_repo }} --username {{ SVN_USERNAME }} --password {{ SVN_PASS }}
  when: SCM == 'SubversionSCM'
    
- name: resolving dependency for libfontconfig
  apt: name=libfontconfig state=present
  
- name: run test
  shell: mvn test
  args:
    chdir: /{{ TESTNAME }}/
  ignore_errors: yes
    
- name: get test results
  fetch: 
    src: /avivaTest/target/surefire-reports/testng-results.xml
    dest: "{{ Sit_test_report_path }}"
    flat: yes
